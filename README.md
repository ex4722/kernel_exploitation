# kernel Exploitation

Learning about kernel exploitation and heres a good place to dump information and notes. 


## Kernel for CTF's
- https://speakerdeck.com/yuawn/kernel-exploitation?slide=1 ( Slides in Chinese but goldmine of commands ) \
- https://github.com/smallkirby/kernelpwn Past CTF examples
- [3 Part writeup](https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1/) Gradually builds up protections and great 
explanation 
- https://duasynt.com/blog/linux-kernel-heap-spray Heap spray 

## Starting Commands:


## Kernel Heap overflow
- http://www.jikos.cz/jikos/Kmalloc_Internals.html 
- https://argp.github.io/2012/01/03/linux-kernel-heap-exploitation/


## Cheatsheets
-https://anhtai.me/linux-kernel-exploit-cheetsheet/ 
-https://ptr-yudai.hatenablog.com/entry/2020/03/16/165628


## TODO:
- Learn how to use c instead of pwn tools
- Figure out how to build a kernel with debug
- Figure out gdb wrong addresses
- Figure out gdb step and breakpoint bug


## TOREAD:
- https://blog.includesecurity.com/2014/06/exploiting-cve-2014-0196-a-walk-through-of-the-linux-pty-race-condition-poc/
- https://devilinside.me/blogs/small-steps-kernel-exploitation
- -https://googleprojectzero.blogspot.com/2021/10/how-simple-linux-kernel-memory.html

## Building Kernel Yourself and GDB
- https://github.com/smallkirby/kernelpwn/tree/master/start-kernel-pwning and https://smallkirby.hatenablog.com/entry/2020/07/23/221605
- Setup .config file with `make allnoconfig` and make sure kernel version is correct
- Setup .config.linux file and make sure debuggings on 
- `build -j<CORES>`
- Bzimage should be in arch/x86/boot/bzImage and vmlinux should be outside
- Gdb in build dir with vmlinux for symbols and source code, lx-commands should work (Make sure to copy .ko module file)
- If si and breakpoints don't work in gdb try https://www.anmolsarma.in/post/single-step-kernel/
  - `./scripts/config -e CONFIG_DEBUG_INFO -d CONFIG_RANDOMIZE_BASE -e CONFIG_MODULES`
  - https://stackoverflow.com/questions/64961631/how-to-skip-timer-interrupt-while-debugging-linux 
  


## Part 1: Barebone Basics
- SMEP is like NX, Kept in CR4 register, overwriting is possible but sometimes its pinned 
- SMAP and KTPI isolates the pages
- `iretq` to exit kernel mode, stack like this `RIP|CS|RFLAGS|SP|SS`
  - Call `swapgs` before to switch kernel/user mode bit
- Without SMAP stack pivioting is just a matter of picking a gadget to move a value into rsp and then mmaping that memory
- KTPI crashes in userspace as pages are kernels pages
    - Register `SIGSEGV` signal handler to call shell despite being in NX pages
    - `KPTI trampoline` swap pages and calls iretq and swagps `swapgs_restore_regs_and_return_to_usermode()
- `ksymtab_FUNCTION` struct has name and offset from struct 
- `modprobe_path` string to executeable when executing unknown file types
    - Overwrite path with shell, execute file with \xff, win
